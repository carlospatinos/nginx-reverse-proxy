# 1 fix of Bad gateway https://stackoverflow.com/questions/38375588/nginx-reverse-proxy-to-heroku-fails-ssl-handshake
# bad request check origin and host for extra characters
# proxy_redirect off; did not fix: 400 The plain HTTP request was sent to HTTPS port

server {

   # access_log /tmp/access.log main;
   # error_log /tmp/error.log error;

   server_name localhost;
   listen 8080;
   listen [::]:8080 default_server ipv6only=on;

   listen 8082 default ssl;
   listen [::]:8082 ipv6only=on default_server ssl;
   ssl off;

   ssl_session_timeout 1d;
   ssl_session_cache shared:SSL:50m;
   ssl_session_tickets off;
   ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
   ssl_ciphers HIGH:!aNULL:!MD5;
   ssl_prefer_server_ciphers on;
    # valid 1s
    # Path for SSL config/key/certificate
    ssl_certificate /usr/share/ssl/example1.crt;
    ssl_certificate_key /usr/share/ssl/example1.key;

   location / {
      autoindex on;
      root  /usr/share/nginx/html/;
   }

   # location /nginx_status {
   #    stub_status;
   #    allow 127.0.0.1;	#only allow requests from   localhost. Make sure to replace this with your locahost address
   #    deny all;		#deny all other hosts	
   # }

   location /nginx_status {
      stub_status on;
      access_log off;
      allow 172.30.0.1;
      allow 127.0.0.1;
      allow 80.233.49.105;
      allow 172.30.149.86;
      allow 169.57.113.186;
      allow 0.0.0.0/8;
      allow 0.0.0.0/24;
      allow 172.0.0.0/8;
      allow 172.0.0.0/24;
      # deny all;
   }
    
   # working 
   location /get_https {
      proxy_pass https://www.google.com/search?q=test;
      # proxy_redirect https://www.google.com/search?q=test https://$host;
      proxy_redirect off;
      proxy_intercept_errors  on;
      proxy_cache off;
      proxy_store off;
      proxy_buffering off;
      proxy_http_version 1.1;
      proxy_read_timeout 36000s;
      proxy_set_header Host www.google.com;
      proxy_set_header Origin http://www.google.com/;
      proxy_set_header Upgrade $http_upgrade;
   #    proxy_set_header Connection $connection_upgrade;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Referer "";
      client_max_body_size 0;
   }

   location /get_http {
      proxy_pass http://info.cern.ch/;
      proxy_redirect http://info.cern.ch/ https://$host;
      proxy_cache off;
      proxy_store off;
      proxy_buffering off;
      proxy_http_version 1.1;
      proxy_read_timeout 36000s;
      proxy_set_header Host info.cern.ch;
      proxy_set_header Origin http://info.cern.ch;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Referer "";
      client_max_body_size 0;
   }


   location /post_api_demo {
      proxy_pass https://ademo-gw-gateway-openshift-operators.cp4i-trial-cv4tz8-e8b59cf553f37698ff3156d883d193e8-0000.us-east.containers.appdomain.cloud/ddd-demo-test/sandbox/reqres/create;
      proxy_redirect https://ademo-gw-gateway-openshift-operators.cp4i-trial-cv4tz8-e8b59cf553f37698ff3156d883d193e8-0000.us-east.containers.appdomain.cloud/ddd-demo-test/sandbox/reqres/create https://$host;
      proxy_cache off;
      proxy_ssl_server_name on;
      proxy_store off;
      proxy_buffering off;
      proxy_http_version 1.1;
      proxy_read_timeout 36000s;
      proxy_set_header Host ademo-gw-gateway-openshift-operators.cp4i-trial-cv4tz8-e8b59cf553f37698ff3156d883d193e8-0000.us-east.containers.appdomain.cloud;
      proxy_set_header Origin https://ademo-gw-gateway-openshift-operators.cp4i-trial-cv4tz8-e8b59cf553f37698ff3156d883d193e8-0000.us-east.containers.appdomain.cloud;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Referer "";
      client_max_body_size 0;
   }

   # Working. fix proxy_ssl_server_name
   location /get_api_demo {
      proxy_pass https://ademo-gw-gateway-openshift-operators.cp4i-trial-cv4tz8-e8b59cf553f37698ff3156d883d193e8-0000.us-east.containers.appdomain.cloud/ddd-demo-test/sandbox/reqres/list-users?pagina=2;
      proxy_redirect https://ademo-gw-gateway-openshift-operators.cp4i-trial-cv4tz8-e8b59cf553f37698ff3156d883d193e8-0000.us-east.containers.appdomain.cloud/ddd-demo-test/sandbox/reqres/list-users?pagina=2 https://$host;
      proxy_cache off;
      proxy_store off;
      proxy_buffering off;
      proxy_ssl_server_name on;
      proxy_http_version 1.1;
      proxy_read_timeout 36000s;
      proxy_set_header Host ademo-gw-gateway-openshift-operators.cp4i-trial-cv4tz8-e8b59cf553f37698ff3156d883d193e8-0000.us-east.containers.appdomain.cloud;
      proxy_set_header Origin https://ademo-gw-gateway-openshift-operators.cp4i-trial-cv4tz8-e8b59cf553f37698ff3156d883d193e8-0000.us-east.containers.appdomain.cloud/;
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
      proxy_set_header Referer "";
      client_max_body_size 0;
   }
}